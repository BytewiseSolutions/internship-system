RewriteEngine On

# Security Headers
<IfModule mod_headers.c>
  # CORS Headers (restrict in production)
  Header set Access-Control-Allow-Origin "*"
  Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
  Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
  
  # Security Headers (development-friendly)
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "no-referrer-when-downgrade"
  
  # Content Security Policy
  Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:;"
</IfModule>

# Handle OPTIONS requests for CORS
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# Redirect /backend/ requests to root
RewriteRule ^backend/(.*)$ /$1 [R=301,L]

# Block access to sensitive files
<FilesMatch "\.(env|htaccess|ini|log|sh|sql|json|md|txt|bak|backup|old|tmp)$">
  Require all denied
</FilesMatch>

# Block access to sensitive directories
<DirectoryMatch "/(logs|backups|temp|cache|config)">
  Require all denied
</DirectoryMatch>

# Prevent access to PHP configuration files
<Files "config.php">
  Require all denied
</Files>

# Rate limiting (if mod_evasive is available)
<IfModule mod_evasive24.c>
  DOSHashTableSize    2048
  DOSPageCount        10
  DOSPageInterval     1
  DOSSiteCount        50
  DOSSiteInterval     1
  DOSBlockingPeriod   600
</IfModule>

# Disable server signature
ServerSignature Off

# Prevent access to version control directories
<DirectoryMatch "\.(git|svn|hg|bzr)">
  Require all denied
</DirectoryMatch>

# File upload security
<Directory "uploads">
  # Prevent execution of scripts in upload directory
  <FilesMatch "\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$">
    Require all denied
  </FilesMatch>
  
  # Only allow specific file types
  <FilesMatch "\.(pdf|doc|docx|jpg|jpeg|png|gif)$">
    Require all granted
  </FilesMatch>
</Directory>

# Compress files for better performance
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
</IfModule>

# Cache static files
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/jpg "access plus 1 month"
  ExpiresByType image/jpeg "access plus 1 month"
  ExpiresByType image/gif "access plus 1 month"
  ExpiresByType image/png "access plus 1 month"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/pdf "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType application/json "access plus 1 week"
</IfModule>